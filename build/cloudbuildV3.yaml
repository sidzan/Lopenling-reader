# This CloudBuild file will build and deploy the application based on 

# This will stop the need to push commits to the k8s-admin repo to deploy the application 

---
# substitition variables can be defined in the trigger definition
substitutions:
  _GCLOUD_PROJECT: production-deployment
  _HELM_RELEASE_NAME_SLUG: preprod
  _HELM_RELEASE_NAME: sefaria-preprod
  _IMAGE__NGINX: sefaria-asset-test  
  _IMAGE__NODEJS: sefaria-node-test
  _IMAGE__WEB: sefaria-web-test
  _TARGET_CLUSTER: preproduction-cluster
  _TARGET_NAMESPACE: default
  _TARGET_REGION: us-central1-a
  _WEB_REPLICAS: "3"
  _K8S_ADMIN_BRANCH: "master"

options:
  machineType: N1_HIGHCPU_8

steps:  

  #
  # Build artifacts
  #
  - name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "gcr.io/production-deployment/sefaria-web:$SHORT_SHA", "-f", "build/web/Dockerfile", "."]
    id: web_container
    wait_for: [ "-" ]
  
  - name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "gcr.io/production-deployment/sefaria-node:$SHORT_SHA", "-f", "build/node/Dockerfile", "."]
    id: nodejs_container
    wait_for: [ "-" ]

  - name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "gcr.io/production-deployment/sefaria-asset:$SHORT_SHA", "-f", "build/nginx/Dockerfile", "--build-arg", "SRC_IMG=gcr.io/production-deployment/sefaria-web:$SHORT_SHA", "."]
    id: nginx_container
    wait_for:
      - web_container

  #
  # Deploy to Kubernetes
  #

  # Clone k8s-admin -- get the `lorenzo/deploy-python3' branch
  - name: "gcr.io/cloud-builders/git"
    args: ['clone', 'https://source.developers.google.com/p/production-deployment/r/k8s-admin', '--branch', '${_K8S_ADMIN_BRANCH}', '--single-branch']
    id: k8s-admin_clone
    wait_for: [ "-" ]

  # Outputs a file to /k8s-admin/v2/app_settings/helm/_sandboxValues.yaml
  - name: gcr.io/${PROJECT_ID}/mongo-restore # used for gettext access
    dir: k8s-admin/v2/app_settings/helm
    entrypoint: "bash"
    args: ['-c', './generateHelmValues.bash']
    id: generate_helm_values
    env: 
      - 'ENV_NAME=${_ENV_NAME}'
      - 'IS_SANDBOX=${_IS_SANDBOX}'
      - 'RESOURCE_ALLOC=${_RESOURCE_ALLOCATION}'
      - 'PROJECT_ID=${PROJECT_ID}'
    wait_for: 
     - k8s-admin_clone
     
  # Outputs a file to /k8s-admin/v2/app_settings/local_settings/_local_settings.py
  - name: gcr.io/${PROJECT_ID}/mongo-restore # used for gettext access
    dir: k8s-admin/v2/app_settings/local_settings
    entrypoint: "bash"
    args: ['-c', './generateLocalSettings.bash']
    id: generate_localsettings_file
    env: 
      - 'ENV_NAME=${_ENV_NAME}'
      - 'IS_SANDBOX=${_IS_SANDBOX}'
      - 'MONGO_HOST=${_MONGO_HOST}' # Should this be parmeterized here or read in the repo
      - 'POSTGRES_HOST=${_POSTGRES_HOST}' # Should this be parmeterized here or read in the repo
    wait_for: 
     - k8s-admin_clone

  # Copy localsettings into file
  # Later, combined this with the script above
  - name: "gcr.io/production-deployment/cloudbuild-helm:v3.0.2"
    dir: k8s-admin/v2
    id: copy_localsettings_file
    entrypoint: cp
    args: ["-f", "./app_settings/local_settings/_local_settings.py", "./charts/sefaria/local_settings.py"]
    wait_for:
      - generate_localsettings_file

  # Idempotently Install/Upgrade the Helm Release
  - name: "gcr.io/production-deployment/cloudbuild-helm:v3.0.2"
    id: install_chart
    dir: k8s-admin/v2    
    args: ["upgrade", "-i", "${_HELM_RELEASE_NAME}", "./charts/sefaria", "--namespace", "${_TARGET_NAMESPACE}", "--set-string", "releaseImageTag=${SHORT_SHA}", "-f", "app_settings/helm/_envValues.yaml", "-f", "app_settings/helm/_resourceValues.yaml", "--debug"]
    env:
      - 'CLOUDSDK_COMPUTE_ZONE=${_TARGET_REGION}'
      - 'CLOUDSDK_CONTAINER_CLUSTER=${_TARGET_CLUSTER}'
      - 'KUBECTL_VERSION=1.14'
      - 'KUBECONFIG=/root/.kube/config'
    wait_for:
      - generate_localsettings_file
      - copy_localsettings_file
      - generate_helm_values
      - k8s-admin_clone
      - nginx_container
      - nodejs_container
      - web_container

  #
  # Post-Deploy Tasks
  #
  # NB: Move these into Helm post-deploy hooks or into the application
  # Post Deploy
  - name: 'gcr.io/cloud-builders/kubectl'
    entrypoint: "bash"
    dir: "k8s-admin/scripts"
    args: ["-c", "apt-get -y update && apt-get -y install curl && ./post_deploy.sh $SHORT_SHA-${_HELM_RELEASE_NAME_SLUG}"]
    env:
    - 'CLOUDSDK_COMPUTE_ZONE=${_TARGET_REGION}'
    - 'CLOUDSDK_CONTAINER_CLUSTER=${_TARGET_CLUSTER}'

  # Todo: 
  # * Share /node_modules while having Dockerfiles that call `npm install`
  #   * I want Dockerfiles to be agnostic about their location -- the old
  #     dockerfiles assumed the container was being built on CloudBuild
    
images:
  - "gcr.io/production-deployment/sefaria-asset:$SHORT_SHA"
  - "gcr.io/production-deployment/sefaria-web:$SHORT_SHA"
  - "gcr.io/production-deployment/sefaria-node:$SHORT_SHA"
...
